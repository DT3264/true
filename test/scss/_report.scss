@use '../../index' as *;
@use '../../sass/report/utils';
@use '../../sass/report';
@use '../../sass/config';
@use '../../sass/data';
@use 'sass:map';

// Report Tests
// ============

$fake-stats: (
  'modules': 4,
  'tests': 6,
  'assertions': 25,
);

$single-stats: '4 Modules, 6 Tests, 25 Assertions';
$multi-stats: ('Stats:', '- 4 Modules', '- 6 Tests', '- 25 Assertions');

$fake-results: (
  'run': 6,
  'pass': 5,
  'fail': 1,
  'output-to-css': 0,
);

$single-results: '6 Tests, 5 Passed, 1 Failed';
$multi-results: ('6 Tests:', '- 5 Passed', '- 1 Failed');

$single: ($single-results, $single-stats);
$multi: data.join-multiple(
  '# SUMMARY ----------',
  $multi-results,
  $multi-stats,
  '--------------------'
);

@include describe('report [mixin]') {
  @include it('Output Message') {
    @include assert {
      @include output {
        @include report.report(false, false, $fake-results, $fake-stats);
      }
      @include expect {
        @include config.message($multi, 'comments');
      }
    }
  }

  @include it('Fail on Error') {
    @include assert {
      @include output {
        @include report.report(false, 'fail on error', $fake-results, $fake-stats);
      }
      @include expect {
        @include config.message($multi, 'comments');
        @include config.error('1 test failed', 'report');
      }
    }
  }

  @include it('Bad results') {
    $bad-results: map.merge(
      $fake-results,
      (
        'pass': 4,
      )
    );
    $bad-lines: ('6 Tests:', '- 4 Passed', '- 1 Failed');
    $bad: data.join-multiple(
      '# SUMMARY ----------',
      $bad-lines,
      $multi-stats,
      '--------------------'
    );

    @include assert {
      @include output {
        @include report.report(false, false, $bad-results, $fake-stats);
      }
      @include expect {
        @include config.message($bad, 'comments');
        @include config.error(
          'The results donâ€™t add up. Are all your tests properly structured?',
          'report'
        );
      }
    }
  }
}

@include describe('report-message [function]') {
  @include it('Single Line') {
    @include assert-equal(
      utils.report-message(not 'linebreaks', $fake-results, $fake-stats),
      $single
    );
  }

  @include it('Linebreaks') {
    @include assert-equal(
      utils.report-message('linebreaks', $fake-results, $fake-stats),
      $multi
    );
  }
}
